<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="icon" type="image/svg+xml" href="/favicon.svg"/><link rel="icon" type="image/png" href="/favicon.png"/><link rel="icon" type="image/x-icon" href="/favicon.ico"/><title>/dev/blog - Reply Challenge 2020 - That&#x27;s what server says</title><meta name="description" content="Writeup for the 300 points Web challenge for Reply Challenge CTF"/><meta name="next-head-count" content="7"/><link rel="preload" href="/_next/static/css/a5f7c6ecf663ea0b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/a5f7c6ecf663ea0b.css" data-n-g=""/><link rel="preload" href="/_next/static/css/2a1840b1c557e13c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/2a1840b1c557e13c.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-fa36d136add6899d.js" defer=""></script><script src="/_next/static/chunks/framework-a87821de553db91d.js" defer=""></script><script src="/_next/static/chunks/main-fc7d2f0e2098927e.js" defer=""></script><script src="/_next/static/chunks/pages/_app-b81dc62f1b146786.js" defer=""></script><script src="/_next/static/chunks/424-2979bed5b87f642b.js" defer=""></script><script src="/_next/static/chunks/25-9ac3dafd1573bf31.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bpath%5D-f9b93aba388814bf.js" defer=""></script><script src="/_next/static/wAy9sOnMpJFbEE6DwNF89/_buildManifest.js" defer=""></script><script src="/_next/static/wAy9sOnMpJFbEE6DwNF89/_ssgManifest.js" defer=""></script><script src="/_next/static/wAy9sOnMpJFbEE6DwNF89/_middlewareManifest.js" defer=""></script></head><body class="bg-slate-50 dark:bg-slate-900"><div id="__next"><header class="p-6 sm:px-12 md:px-24 lg:px-48 xl:px-60 2xl:px-96"><nav class="flex flex-row items-center"><a href="/"><h1 class=" text-slate-900 dark:text-slate-50 text-4xl font-extrabold tracking-tight sm:text-5xl md:text-6xl">/dev/blog</h1></a><ul class="flex flex-row flex-grow items-end justify-evenly"><li><a href="/posts"><span class="underline text-slate-900 dark:text-slate-50 text-sm sm:text-base xl:text-lg">Posts</span></a></li><li><a href="/notes"><span class=" text-slate-900 dark:text-slate-50 text-sm sm:text-base xl:text-lg">Notes</span></a></li></ul><button class="undefined text-slate-900 border-slate-900 dark:border-slate-50 dark:text-slate-50 rounded border-t-2 border-l-2 border-r-4 border-b-4 px-4 py-2  hover:bg-slate-100 dark:hover:bg-slate-800 active:translate-y-0.5">Auto</button></nav></header><main class="flex flex-col justify-center p-6 sm:px-12 md:px-24 lg:px-48 xl:px-60 2xl:px-96"><article class="max-w-full grow flex flex-col justify-self-start"><h1 class="mb-4 text-slate-900 dark:text-slate-50 text-4xl font-extrabold tracking-tight sm:text-5xl md:text-6xl">Reply Challenge 2020 - That<!-- -->’<!-- -->s what server says<!-- --></h1><p class="mb-2 inline text-slate-900 dark:text-slate-50 text-sm sm:text-base xl:text-lg">This is the Writeup for the 300 points Web challenge for Reply Challenge CTF.<!-- -->
<!-- -->During the CTF I and my team achieved first blood on this challenge. The<!-- -->
<!-- -->challenge consists of finding a service endpoint on a web page, with a login<!-- -->
<!-- -->API. Then you have to exploit an <!-- --><strong>XXE<!-- --></strong> (XML External Entities) Injection to<!-- -->
<!-- -->get an <!-- --><strong>LFI<!-- --></strong> (Local File Inclusion) to get the sysadmin credentials to login<!-- -->
<!-- -->on the service and get the flag.<!-- --></p><h2 class="mb-4 text-slate-900 dark:text-slate-50 text-3xl font-bold tracking-tight sm:text-4xl md:text-5xl">Service discovery<!-- --></h2><p class="mb-2 inline text-slate-900 dark:text-slate-50 text-sm sm:text-base xl:text-lg">Fist we land on a page with just a <!-- -->&lt;h1&gt;<!-- --> title and an <!-- -->&lt;img&gt;<!-- -->. The title talks<!-- -->
<!-- -->about <!-- --><strong>robots<!-- --></strong> and in the image there are some blackberries. So as they<!-- -->
<!-- -->hinted we navigate to the <!-- -->/robots.txt<!-- --> files to find if there are some<!-- -->
<!-- -->disallowed entries. We are greeted by the character Michael from The Office<!-- -->
<!-- -->saying <!-- --><em>“<!-- -->You<!-- -->’<!-- -->re not my friend Barry<!-- -->”<!-- --></em>.<!-- --></p><h3 class="mb-4 text-slate-900 dark:text-slate-50 text-2xl font-bold tracking-tight sm:text-3xl md:text-4xl">User Agent<!-- --></h3><p class="mb-2 inline text-slate-900 dark:text-slate-50 text-sm sm:text-base xl:text-lg">Since the <!-- -->roots.txt<!-- --> file is blocked and there is anything else on the main<!-- -->
<!-- -->page, we have to circumvent the check on this file. They hinted to us something<!-- -->
<!-- -->about berries or blackberries. So we can try to access the <!-- -->robots.txt<!-- --> as a<!-- -->
<!-- -->BlackBerry phone. This can be done by changing the <!-- -->User-Agent<!-- --> header of your<!-- -->
<!-- -->HTTP request. We can find a list of valid <!-- -->User-Agent<!-- --> string on<!-- -->
<!-- --><a title="" class="text-secondary-700 visited:text-secondary-900 font-bold hover:underline" href="http://www.useragentstring.com/pages/useragentstring.php?name=BlackBerry">this website<!-- --></a>.<!-- -->
<!-- -->After we changed the <!-- -->User-agent<!-- --> we revisit the page and now we can see a<!-- -->
<!-- -->disallowed entry <!-- -->/file_upload.php<!-- -->.<!-- --></p><p class="mb-2 inline text-slate-900 dark:text-slate-50 text-sm sm:text-base xl:text-lg"><img src="/images/reply-challenges/robots.png" alt=""/></p><h3 class="mb-4 text-slate-900 dark:text-slate-50 text-2xl font-bold tracking-tight sm:text-3xl md:text-4xl">File Upload<!-- --></h3><p class="mb-2 inline text-slate-900 dark:text-slate-50 text-sm sm:text-base xl:text-lg">The <!-- -->file_upload.php<!-- --> API permits us to upload a <!-- -->[png, jpg, jpeg, gif]<!-- --> file<!-- -->
<!-- -->to the machine and will return where the file was uploaded.<!-- --></p><blockquote><p class="mb-2 inline text-slate-900 dark:text-slate-50 text-sm sm:text-base xl:text-lg">Spoiler: we never use the uploaded file (rev shell or other) probably was a<!-- -->
<!-- -->rabbit hole.<!-- --></p></blockquote><p class="mb-2 inline text-slate-900 dark:text-slate-50 text-sm sm:text-base xl:text-lg">There are two curious facts about this API. The first is that the <!-- -->POST<!-- -->
<!-- -->request has sent three values:<!-- --></p><ul class="mb-2 ml-6 text-slate-900 dark:text-slate-50 list-disc"><li><strong>fileToUpload<!-- --></strong>: The file to upload and its filename<!-- --></li><li><strong>req<!-- --></strong>: A string that represents an endpoint on the server<!-- --></li><li><strong>submit<!-- --></strong>: A request method (POST)<!-- --></li></ul><p class="mb-2 inline text-slate-900 dark:text-slate-50 text-sm sm:text-base xl:text-lg">The second one is when you send the request without uploading a file, you get a<!-- -->
<!-- -->message to contact the sysadmin to use the API <!-- -->/services<!-- --> and set the<!-- -->
<!-- -->authorized.xml<!-- --> file.<!-- --></p><p class="mb-2 inline text-slate-900 dark:text-slate-50 text-sm sm:text-base xl:text-lg"><img src="/images/reply-challenges/sysadmin.png" alt=""/></p><h2 class="mb-4 text-slate-900 dark:text-slate-50 text-3xl font-bold tracking-tight sm:text-4xl md:text-5xl">Exploitation<!-- --></h2><p class="mb-2 inline text-slate-900 dark:text-slate-50 text-sm sm:text-base xl:text-lg">We can not access the <!-- -->/services<!-- --> from our machine, so we can try to use<!-- -->
<!-- -->file_upload.php<!-- --> to communicate with this API. First, we can try to change the<!-- -->
<!-- -->req<!-- --> value to <!-- -->/services<!-- --> and check what we get back. Sending an image we get<!-- -->
<!-- -->that the page doesn<!-- -->’<!-- -->t support this method. Then we change the <!-- -->submit<!-- --> value to<!-- -->
<!-- -->GET<!-- -->. The page responds with an HTML/XML body. This is <!-- --><strong>XML WSDL<!-- --></strong> a standard<!-- -->
<!-- -->for Web Services Description Language, it is used to describe web services.<!-- --></p><p class="mb-2 inline text-slate-900 dark:text-slate-50 text-sm sm:text-base xl:text-lg"><img src="/images/reply-challenges/services.png" alt=""/></p><p class="mb-2 inline text-slate-900 dark:text-slate-50 text-sm sm:text-base xl:text-lg">We can see that the services have an endpoint at <!-- -->/services/perform_login<!-- -->
<!-- -->requires as input a <!-- -->user<!-- --> and a <!-- -->pwd<!-- --> that is probably the one in the<!-- -->
<!-- -->authorized.xml<!-- --> referenced before.<!-- --></p><h3 class="mb-4 text-slate-900 dark:text-slate-50 text-2xl font-bold tracking-tight sm:text-3xl md:text-4xl">XXE Injection<!-- --></h3><p class="mb-2 inline text-slate-900 dark:text-slate-50 text-sm sm:text-base xl:text-lg">We can now try to send the file to the login API. If we send an image the<!-- -->
<!-- -->endpoint returns <!-- -->XML Format Error<!-- -->, so we know that the page requires an XML<!-- -->
<!-- -->file. Unfortunately, <!-- -->file_upload.php<!-- --> only accepts certain extension, we need<!-- -->
<!-- -->to craft or XML payload and rename the file to a valid extension like <!-- -->.jpg<!-- -->.<!-- --></p><p class="mb-2 inline text-slate-900 dark:text-slate-50 text-sm sm:text-base xl:text-lg">From the XML WSDL, we know the arguments that are required, and with a bit of<!-- -->
<!-- -->trial and error, we can find the right format of the payload.<!-- --></p><pre class="language-xml mb-2 overflow-auto border-slate-900 dark:border-slate-50 border-2 rounded p-4"><code>&lt;user&gt;test&lt;/user&gt;
<!-- --></code></pre><p class="mb-2 inline text-slate-900 dark:text-slate-50 text-sm sm:text-base xl:text-lg">When we send the post we get an error saying:<!-- --></p><pre class="language- mb-2 overflow-auto border-slate-900 dark:border-slate-50 border-2 rounded p-4"><code>test is not a register user
<!-- --></code></pre><p class="mb-2 inline text-slate-900 dark:text-slate-50 text-sm sm:text-base xl:text-lg">Now we have a value <!-- -->user<!-- --> that can output on the response. This means we can<!-- -->
<!-- -->make an XXE Injection to get the <!-- -->authorized.xml<!-- --> file as the user value and<!-- -->
<!-- -->make the response print it as an error for profit. We can guess the position of<!-- -->
<!-- -->the file because the response includes where our image was uploaded, or we<!-- -->
<!-- -->could try and get the entire directory, or a known file like <!-- -->/etc/passwd<!-- -->.<!-- --></p><p class="mb-2 inline text-slate-900 dark:text-slate-50 text-sm sm:text-base xl:text-lg">The final payload is the following.<!-- --></p><pre class="language-xml mb-2 overflow-auto border-slate-900 dark:border-slate-50 border-2 rounded p-4"><code>&lt;!DOCTYPE root [!ENTITY test SYSTEM &#x27;file:///var/chall300_web/authorized.xml&#x27;&gt;]&gt;
&lt;user&gt;&amp;test;&lt;/user&gt;
<!-- --></code></pre><p class="mb-2 inline text-slate-900 dark:text-slate-50 text-sm sm:text-base xl:text-lg"><img src="/images/reply-challenges/flag.png" alt=""/></p><blockquote><p class="mb-2 inline text-slate-900 dark:text-slate-50 text-sm sm:text-base xl:text-lg">If you want to read more about XXE here<!-- -->
<!-- --><a title="" class="text-secondary-700 visited:text-secondary-900 font-bold hover:underline" href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20Injection">PayloadAllTheThings/XXE Injection<!-- --></a></p></blockquote></article></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"article":{"title":"Reply Challenge 2020 - That's what server says","tags":["CTF"],"date":"2020-10-10","description":"Writeup for the 300 points Web challenge for Reply Challenge CTF","language":null,"content":[{"Start":{"Heading":["H1",null,[]]}},{"Text":"Reply Challenge 2020 - That"},{"Text":"’"},{"Text":"s what server says"},{"End":{"Heading":["H1",null,[]]}},{"Start":"Paragraph"},{"Text":"This is the Writeup for the 300 points Web challenge for Reply Challenge CTF."},"SoftBreak",{"Text":"During the CTF I and my team achieved first blood on this challenge. The"},"SoftBreak",{"Text":"challenge consists of finding a service endpoint on a web page, with a login"},"SoftBreak",{"Text":"API. Then you have to exploit an "},{"Start":"Strong"},{"Text":"XXE"},{"End":"Strong"},{"Text":" (XML External Entities) Injection to"},"SoftBreak",{"Text":"get an "},{"Start":"Strong"},{"Text":"LFI"},{"End":"Strong"},{"Text":" (Local File Inclusion) to get the sysadmin credentials to login"},"SoftBreak",{"Text":"on the service and get the flag."},{"End":"Paragraph"},{"Start":{"Heading":["H2",null,[]]}},{"Text":"Service discovery"},{"End":{"Heading":["H2",null,[]]}},{"Start":"Paragraph"},{"Text":"Fist we land on a page with just a "},{"Code":"\u003ch1\u003e"},{"Text":" title and an "},{"Code":"\u003cimg\u003e"},{"Text":". The title talks"},"SoftBreak",{"Text":"about "},{"Start":"Strong"},{"Text":"robots"},{"End":"Strong"},{"Text":" and in the image there are some blackberries. So as they"},"SoftBreak",{"Text":"hinted we navigate to the "},{"Code":"/robots.txt"},{"Text":" files to find if there are some"},"SoftBreak",{"Text":"disallowed entries. We are greeted by the character Michael from The Office"},"SoftBreak",{"Text":"saying "},{"Start":"Emphasis"},{"Text":"“"},{"Text":"You"},{"Text":"’"},{"Text":"re not my friend Barry"},{"Text":"”"},{"End":"Emphasis"},{"Text":"."},{"End":"Paragraph"},{"Start":{"Heading":["H3",null,[]]}},{"Text":"User Agent"},{"End":{"Heading":["H3",null,[]]}},{"Start":"Paragraph"},{"Text":"Since the "},{"Code":"roots.txt"},{"Text":" file is blocked and there is anything else on the main"},"SoftBreak",{"Text":"page, we have to circumvent the check on this file. They hinted to us something"},"SoftBreak",{"Text":"about berries or blackberries. So we can try to access the "},{"Code":"robots.txt"},{"Text":" as a"},"SoftBreak",{"Text":"BlackBerry phone. This can be done by changing the "},{"Code":"User-Agent"},{"Text":" header of your"},"SoftBreak",{"Text":"HTTP request. We can find a list of valid "},{"Code":"User-Agent"},{"Text":" string on"},"SoftBreak",{"Start":{"Link":["Inline","http://www.useragentstring.com/pages/useragentstring.php?name=BlackBerry",""]}},{"Text":"this website"},{"End":{"Link":["Inline","http://www.useragentstring.com/pages/useragentstring.php?name=BlackBerry",""]}},{"Text":"."},"SoftBreak",{"Text":"After we changed the "},{"Code":"User-agent"},{"Text":" we revisit the page and now we can see a"},"SoftBreak",{"Text":"disallowed entry "},{"Code":"/file_upload.php"},{"Text":"."},{"End":"Paragraph"},{"Start":"Paragraph"},{"Start":{"Image":["Inline","/images/reply-challenges/robots.png",""]}},{"Text":"robots.txt"},{"End":{"Image":["Inline","/images/reply-challenges/robots.png",""]}},{"End":"Paragraph"},{"Start":{"Heading":["H3",null,[]]}},{"Text":"File Upload"},{"End":{"Heading":["H3",null,[]]}},{"Start":"Paragraph"},{"Text":"The "},{"Code":"file_upload.php"},{"Text":" API permits us to upload a "},{"Code":"[png, jpg, jpeg, gif]"},{"Text":" file"},"SoftBreak",{"Text":"to the machine and will return where the file was uploaded."},{"End":"Paragraph"},{"Start":"BlockQuote"},{"Start":"Paragraph"},{"Text":"Spoiler: we never use the uploaded file (rev shell or other) probably was a"},"SoftBreak",{"Text":"rabbit hole."},{"End":"Paragraph"},{"End":"BlockQuote"},{"Start":"Paragraph"},{"Text":"There are two curious facts about this API. The first is that the "},{"Code":"POST"},"SoftBreak",{"Text":"request has sent three values:"},{"End":"Paragraph"},{"Start":{"List":null}},{"Start":"Item"},{"Start":"Strong"},{"Text":"fileToUpload"},{"End":"Strong"},{"Text":": The file to upload and its filename"},{"End":"Item"},{"Start":"Item"},{"Start":"Strong"},{"Text":"req"},{"End":"Strong"},{"Text":": A string that represents an endpoint on the server"},{"End":"Item"},{"Start":"Item"},{"Start":"Strong"},{"Text":"submit"},{"End":"Strong"},{"Text":": A request method (POST)"},{"End":"Item"},{"End":{"List":null}},{"Start":"Paragraph"},{"Text":"The second one is when you send the request without uploading a file, you get a"},"SoftBreak",{"Text":"message to contact the sysadmin to use the API "},{"Code":"/services"},{"Text":" and set the"},"SoftBreak",{"Code":"authorized.xml"},{"Text":" file."},{"End":"Paragraph"},{"Start":"Paragraph"},{"Start":{"Image":["Inline","/images/reply-challenges/sysadmin.png",""]}},{"Text":"sysadmin"},{"End":{"Image":["Inline","/images/reply-challenges/sysadmin.png",""]}},{"End":"Paragraph"},{"Start":{"Heading":["H2",null,[]]}},{"Text":"Exploitation"},{"End":{"Heading":["H2",null,[]]}},{"Start":"Paragraph"},{"Text":"We can not access the "},{"Code":"/services"},{"Text":" from our machine, so we can try to use"},"SoftBreak",{"Code":"file_upload.php"},{"Text":" to communicate with this API. First, we can try to change the"},"SoftBreak",{"Code":"req"},{"Text":" value to "},{"Code":"/services"},{"Text":" and check what we get back. Sending an image we get"},"SoftBreak",{"Text":"that the page doesn"},{"Text":"’"},{"Text":"t support this method. Then we change the "},{"Code":"submit"},{"Text":" value to"},"SoftBreak",{"Code":"GET"},{"Text":". The page responds with an HTML/XML body. This is "},{"Start":"Strong"},{"Text":"XML WSDL"},{"End":"Strong"},{"Text":" a standard"},"SoftBreak",{"Text":"for Web Services Description Language, it is used to describe web services."},{"End":"Paragraph"},{"Start":"Paragraph"},{"Start":{"Image":["Inline","/images/reply-challenges/services.png",""]}},{"Text":"/services"},{"End":{"Image":["Inline","/images/reply-challenges/services.png",""]}},{"End":"Paragraph"},{"Start":"Paragraph"},{"Text":"We can see that the services have an endpoint at "},{"Code":"/services/perform_login"},"SoftBreak",{"Text":"requires as input a "},{"Code":"user"},{"Text":" and a "},{"Code":"pwd"},{"Text":" that is probably the one in the"},"SoftBreak",{"Code":"authorized.xml"},{"Text":" referenced before."},{"End":"Paragraph"},{"Start":{"Heading":["H3",null,[]]}},{"Text":"XXE Injection"},{"End":{"Heading":["H3",null,[]]}},{"Start":"Paragraph"},{"Text":"We can now try to send the file to the login API. If we send an image the"},"SoftBreak",{"Text":"endpoint returns "},{"Code":"XML Format Error"},{"Text":", so we know that the page requires an XML"},"SoftBreak",{"Text":"file. Unfortunately, "},{"Code":"file_upload.php"},{"Text":" only accepts certain extension, we need"},"SoftBreak",{"Text":"to craft or XML payload and rename the file to a valid extension like "},{"Code":".jpg"},{"Text":"."},{"End":"Paragraph"},{"Start":"Paragraph"},{"Text":"From the XML WSDL, we know the arguments that are required, and with a bit of"},"SoftBreak",{"Text":"trial and error, we can find the right format of the payload."},{"End":"Paragraph"},{"Start":{"CodeBlock":{"Fenced":"xml"}}},{"Text":"\u003cuser\u003etest\u003c/user\u003e\n"},{"End":{"CodeBlock":{"Fenced":"xml"}}},{"Start":"Paragraph"},{"Text":"When we send the post we get an error saying:"},{"End":"Paragraph"},{"Start":{"CodeBlock":{"Fenced":""}}},{"Text":"test is not a register user\n"},{"End":{"CodeBlock":{"Fenced":""}}},{"Start":"Paragraph"},{"Text":"Now we have a value "},{"Code":"user"},{"Text":" that can output on the response. This means we can"},"SoftBreak",{"Text":"make an XXE Injection to get the "},{"Code":"authorized.xml"},{"Text":" file as the user value and"},"SoftBreak",{"Text":"make the response print it as an error for profit. We can guess the position of"},"SoftBreak",{"Text":"the file because the response includes where our image was uploaded, or we"},"SoftBreak",{"Text":"could try and get the entire directory, or a known file like "},{"Code":"/etc/passwd"},{"Text":"."},{"End":"Paragraph"},{"Start":"Paragraph"},{"Text":"The final payload is the following."},{"End":"Paragraph"},{"Start":{"CodeBlock":{"Fenced":"xml"}}},{"Text":"\u003c!DOCTYPE root [!ENTITY test SYSTEM 'file:///var/chall300_web/authorized.xml'\u003e]\u003e\n\u003cuser\u003e\u0026test;\u003c/user\u003e\n"},{"End":{"CodeBlock":{"Fenced":"xml"}}},{"Start":"Paragraph"},{"Start":{"Image":["Inline","/images/reply-challenges/flag.png",""]}},{"Text":"flag"},{"End":{"Image":["Inline","/images/reply-challenges/flag.png",""]}},{"End":"Paragraph"},{"Start":"BlockQuote"},{"Start":"Paragraph"},{"Text":"If you want to read more about XXE here"},"SoftBreak",{"Start":{"Link":["Inline","https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20Injection",""]}},{"Text":"PayloadAllTheThings/XXE Injection"},{"End":{"Link":["Inline","https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20Injection",""]}},{"End":"Paragraph"},{"End":"BlockQuote"}]}},"__N_SSG":true},"page":"/posts/[path]","query":{"path":"reply_challenges_2020_that_is_what_server_says"},"buildId":"wAy9sOnMpJFbEE6DwNF89","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>