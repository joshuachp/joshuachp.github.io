{"pageProps":{"article":{"title":"Reply Challenge 2020 - That's what server says","tags":["CTF"],"date":"2020-10-10","description":"Writeup for the 300 points Web challenge for Reply Challenge CTF","language":null,"content":[{"Start":{"Heading":["H1",null,[]]}},{"Text":"Reply Challenge 2020 - That"},{"Text":"’"},{"Text":"s what server says"},{"End":{"Heading":["H1",null,[]]}},{"Start":"Paragraph"},{"Text":"This is the Writeup for the 300 points Web challenge for Reply Challenge CTF."},"SoftBreak",{"Text":"During the CTF I and my team achieved first blood on this challenge. The"},"SoftBreak",{"Text":"challenge consists of finding a service endpoint on a web page, with a login"},"SoftBreak",{"Text":"API. Then you have to exploit an "},{"Start":"Strong"},{"Text":"XXE"},{"End":"Strong"},{"Text":" (XML External Entities) Injection to"},"SoftBreak",{"Text":"get an "},{"Start":"Strong"},{"Text":"LFI"},{"End":"Strong"},{"Text":" (Local File Inclusion) to get the sysadmin credentials to login"},"SoftBreak",{"Text":"on the service and get the flag."},{"End":"Paragraph"},{"Start":{"Heading":["H2",null,[]]}},{"Text":"Service discovery"},{"End":{"Heading":["H2",null,[]]}},{"Start":"Paragraph"},{"Text":"Fist we land on a page with just a "},{"Code":"<h1>"},{"Text":" title and an "},{"Code":"<img>"},{"Text":". The title talks"},"SoftBreak",{"Text":"about "},{"Start":"Strong"},{"Text":"robots"},{"End":"Strong"},{"Text":" and in the image there are some blackberries. So as they"},"SoftBreak",{"Text":"hinted we navigate to the "},{"Code":"/robots.txt"},{"Text":" files to find if there are some"},"SoftBreak",{"Text":"disallowed entries. We are greeted by the character Michael from The Office"},"SoftBreak",{"Text":"saying "},{"Start":"Emphasis"},{"Text":"“"},{"Text":"You"},{"Text":"’"},{"Text":"re not my friend Barry"},{"Text":"”"},{"End":"Emphasis"},{"Text":"."},{"End":"Paragraph"},{"Start":{"Heading":["H3",null,[]]}},{"Text":"User Agent"},{"End":{"Heading":["H3",null,[]]}},{"Start":"Paragraph"},{"Text":"Since the "},{"Code":"roots.txt"},{"Text":" file is blocked and there is anything else on the main"},"SoftBreak",{"Text":"page, we have to circumvent the check on this file. They hinted to us something"},"SoftBreak",{"Text":"about berries or blackberries. So we can try to access the "},{"Code":"robots.txt"},{"Text":" as a"},"SoftBreak",{"Text":"BlackBerry phone. This can be done by changing the "},{"Code":"User-Agent"},{"Text":" header of your"},"SoftBreak",{"Text":"HTTP request. We can find a list of valid "},{"Code":"User-Agent"},{"Text":" string on"},"SoftBreak",{"Start":{"Link":["Inline","http://www.useragentstring.com/pages/useragentstring.php?name=BlackBerry",""]}},{"Text":"this website"},{"End":{"Link":["Inline","http://www.useragentstring.com/pages/useragentstring.php?name=BlackBerry",""]}},{"Text":"."},"SoftBreak",{"Text":"After we changed the "},{"Code":"User-agent"},{"Text":" we revisit the page and now we can see a"},"SoftBreak",{"Text":"disallowed entry "},{"Code":"/file_upload.php"},{"Text":"."},{"End":"Paragraph"},{"Start":"Paragraph"},{"Start":{"Image":["Inline","/images/reply-challenges/robots.png",""]}},{"Text":"robots.txt"},{"End":{"Image":["Inline","/images/reply-challenges/robots.png",""]}},{"End":"Paragraph"},{"Start":{"Heading":["H3",null,[]]}},{"Text":"File Upload"},{"End":{"Heading":["H3",null,[]]}},{"Start":"Paragraph"},{"Text":"The "},{"Code":"file_upload.php"},{"Text":" API permits us to upload a "},{"Code":"[png, jpg, jpeg, gif]"},{"Text":" file"},"SoftBreak",{"Text":"to the machine and will return where the file was uploaded."},{"End":"Paragraph"},{"Start":"BlockQuote"},{"Start":"Paragraph"},{"Text":"Spoiler: we never use the uploaded file (rev shell or other) probably was a"},"SoftBreak",{"Text":"rabbit hole."},{"End":"Paragraph"},{"End":"BlockQuote"},{"Start":"Paragraph"},{"Text":"There are two curious facts about this API. The first is that the "},{"Code":"POST"},"SoftBreak",{"Text":"request has sent three values:"},{"End":"Paragraph"},{"Start":{"List":null}},{"Start":"Item"},{"Start":"Strong"},{"Text":"fileToUpload"},{"End":"Strong"},{"Text":": The file to upload and its filename"},{"End":"Item"},{"Start":"Item"},{"Start":"Strong"},{"Text":"req"},{"End":"Strong"},{"Text":": A string that represents an endpoint on the server"},{"End":"Item"},{"Start":"Item"},{"Start":"Strong"},{"Text":"submit"},{"End":"Strong"},{"Text":": A request method (POST)"},{"End":"Item"},{"End":{"List":null}},{"Start":"Paragraph"},{"Text":"The second one is when you send the request without uploading a file, you get a"},"SoftBreak",{"Text":"message to contact the sysadmin to use the API "},{"Code":"/services"},{"Text":" and set the"},"SoftBreak",{"Code":"authorized.xml"},{"Text":" file."},{"End":"Paragraph"},{"Start":"Paragraph"},{"Start":{"Image":["Inline","/images/reply-challenges/sysadmin.png",""]}},{"Text":"sysadmin"},{"End":{"Image":["Inline","/images/reply-challenges/sysadmin.png",""]}},{"End":"Paragraph"},{"Start":{"Heading":["H2",null,[]]}},{"Text":"Exploitation"},{"End":{"Heading":["H2",null,[]]}},{"Start":"Paragraph"},{"Text":"We can not access the "},{"Code":"/services"},{"Text":" from our machine, so we can try to use"},"SoftBreak",{"Code":"file_upload.php"},{"Text":" to communicate with this API. First, we can try to change the"},"SoftBreak",{"Code":"req"},{"Text":" value to "},{"Code":"/services"},{"Text":" and check what we get back. Sending an image we get"},"SoftBreak",{"Text":"that the page doesn"},{"Text":"’"},{"Text":"t support this method. Then we change the "},{"Code":"submit"},{"Text":" value to"},"SoftBreak",{"Code":"GET"},{"Text":". The page responds with an HTML/XML body. This is "},{"Start":"Strong"},{"Text":"XML WSDL"},{"End":"Strong"},{"Text":" a standard"},"SoftBreak",{"Text":"for Web Services Description Language, it is used to describe web services."},{"End":"Paragraph"},{"Start":"Paragraph"},{"Start":{"Image":["Inline","/images/reply-challenges/services.png",""]}},{"Text":"/services"},{"End":{"Image":["Inline","/images/reply-challenges/services.png",""]}},{"End":"Paragraph"},{"Start":"Paragraph"},{"Text":"We can see that the services have an endpoint at "},{"Code":"/services/perform_login"},"SoftBreak",{"Text":"requires as input a "},{"Code":"user"},{"Text":" and a "},{"Code":"pwd"},{"Text":" that is probably the one in the"},"SoftBreak",{"Code":"authorized.xml"},{"Text":" referenced before."},{"End":"Paragraph"},{"Start":{"Heading":["H3",null,[]]}},{"Text":"XXE Injection"},{"End":{"Heading":["H3",null,[]]}},{"Start":"Paragraph"},{"Text":"We can now try to send the file to the login API. If we send an image the"},"SoftBreak",{"Text":"endpoint returns "},{"Code":"XML Format Error"},{"Text":", so we know that the page requires an XML"},"SoftBreak",{"Text":"file. Unfortunately, "},{"Code":"file_upload.php"},{"Text":" only accepts certain extension, we need"},"SoftBreak",{"Text":"to craft or XML payload and rename the file to a valid extension like "},{"Code":".jpg"},{"Text":"."},{"End":"Paragraph"},{"Start":"Paragraph"},{"Text":"From the XML WSDL, we know the arguments that are required, and with a bit of"},"SoftBreak",{"Text":"trial and error, we can find the right format of the payload."},{"End":"Paragraph"},{"Start":{"CodeBlock":{"Fenced":"xml"}}},{"Text":"<user>test</user>\n"},{"End":{"CodeBlock":{"Fenced":"xml"}}},{"Start":"Paragraph"},{"Text":"When we send the post we get an error saying:"},{"End":"Paragraph"},{"Start":{"CodeBlock":{"Fenced":""}}},{"Text":"test is not a register user\n"},{"End":{"CodeBlock":{"Fenced":""}}},{"Start":"Paragraph"},{"Text":"Now we have a value "},{"Code":"user"},{"Text":" that can output on the response. This means we can"},"SoftBreak",{"Text":"make an XXE Injection to get the "},{"Code":"authorized.xml"},{"Text":" file as the user value and"},"SoftBreak",{"Text":"make the response print it as an error for profit. We can guess the position of"},"SoftBreak",{"Text":"the file because the response includes where our image was uploaded, or we"},"SoftBreak",{"Text":"could try and get the entire directory, or a known file like "},{"Code":"/etc/passwd"},{"Text":"."},{"End":"Paragraph"},{"Start":"Paragraph"},{"Text":"The final payload is the following."},{"End":"Paragraph"},{"Start":{"CodeBlock":{"Fenced":"xml"}}},{"Text":"<!DOCTYPE root [!ENTITY test SYSTEM 'file:///var/chall300_web/authorized.xml'>]>\n<user>&test;</user>\n"},{"End":{"CodeBlock":{"Fenced":"xml"}}},{"Start":"Paragraph"},{"Start":{"Image":["Inline","/images/reply-challenges/flag.png",""]}},{"Text":"flag"},{"End":{"Image":["Inline","/images/reply-challenges/flag.png",""]}},{"End":"Paragraph"},{"Start":"BlockQuote"},{"Start":"Paragraph"},{"Text":"If you want to read more about XXE here"},"SoftBreak",{"Start":{"Link":["Inline","https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20Injection",""]}},{"Text":"PayloadAllTheThings/XXE Injection"},{"End":{"Link":["Inline","https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20Injection",""]}},{"End":"Paragraph"},{"End":"BlockQuote"}]}},"__N_SSG":true}