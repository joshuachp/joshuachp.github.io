{"pageProps":{"path":"2022-07-02","article":{"title":"Jouranl 2022-07-02","description":null,"tags":["journal"],"date":"2022-07-02","draft":false,"language":"en","content":[{"Start":{"Heading":["H1",null,[]]}},{"Text":"Journal 2022-07-02"},{"End":{"Heading":["H1",null,[]]}},{"Start":"Paragraph"},{"Text":"Hi, I"},{"Text":"’"},{"Text":"ve been following the topic for a while, trying to fix the crash on with"},"SoftBreak",{"Text":"sync (not reverse prime). I managed to make it work with the following config:"},{"End":"Paragraph"},{"Start":"Paragraph"},{"Text":"Video config "},{"Code":"configuration.nix "},{"End":"Paragraph"},{"Html":"<details title=\"video-configuration.nix\">\n"},{"Start":{"CodeBlock":{"Fenced":"nix"}}},{"Text":"{ config\n, pkgs\n, lib\n, ...\n}: {\n  config = {\n    services.xserver.exportConfiguration = true;\n\n    services.xserver.videoDrivers = [\n      # \"modesetting\"\n      # \"fbdev\"\n      \"amdgpu\"\n      \"nvidia\"\n    ];\n\n    hardware.opengl = {\n      enable = true;\n\n      extraPackages = with pkgs; [\n        rocm-opencl-icd\n        rocm-opencl-runtime\n        amdvlk\n        vaapiVdpau\n      ];\n\n      driSupport = true;\n    };\n\n\n    hardware.nvidia = {\n      #powerManagement = {\n      #  enable = true;\n      #  finegrained = true;\n      #};\n\n      nvidiaPersistenced = true;\n\n      modesetting.enable = true;\n\n      prime = {\n        #offload.enable = true;\n        sync.enable = true;\n\n        amdgpuBusId = \"PCI:5:0:0\";\n        nvidiaBusId = \"PCI:1:0:0\";\n      };\n    };\n\n    environment.etc.\"X11/xorg.conf.d/10-amdgpu.conf\".text = ''\n      Section \"OutputClass\"\n          Identifier \"AMDgpu\"\n          MatchDriver \"amdgpu\"\n          Driver \"amdgpu\"\n      EndSection\n    '';\n\n    environment.etc.\"X11/xorg.conf.d/10-radeon.conf\".text = ''\n      Section \"OutputClass\"\n          Identifier \"Radeon\"\n          MatchDriver \"radeon\"\n          Driver \"radeon\"\n      EndSection\n    '';\n\n    environment.etc.\"X11/xorg.conf.d/10-nvidia.conf\".text = ''\n      Section \"OutputClass\"\n          Identifier \"nvidia\"\n          MatchDriver \"nvidia-drm\"\n          Driver \"nvidia\"\n          Option \"AllowEmptyInitialConfiguration\"\n          Option \"SLI\" \"Auto\"\n          Option \"BaseMosaic\" \"on\"\n      EndSection\n\n      Section \"ServerLayout\"\n          Identifier \"layout\"\n          Option \"AllowNVIDIAGPUScreens\"\n      EndSection\n    '';\n\n    services.xserver.config = lib.mkForce ''\n      Section \"ServerFlags\"\n        Option \"AllowMouseOpenFail\" \"on\"\n        Option \"DontZap\" \"on\"\n      EndSection\n\n      Section \"Module\"\n      EndSection\n\n      Section \"Monitor\"\n        Identifier \"Monitor[0]\"\n      EndSection\n\n      # Additional \"InputClass\" sections\n      Section \"InputClass\"\n        Identifier \"libinput mouse configuration\"\n        MatchDriver \"libinput\"\n        MatchIsPointer \"on\"\n        Option \"AccelProfile\" \"adaptive\"\n        Option \"LeftHanded\" \"off\"\n        Option \"MiddleEmulation\" \"on\"\n        Option \"NaturalScrolling\" \"off\"\n        Option \"ScrollMethod\" \"twofinger\"\n        Option \"HorizontalScrolling\" \"on\"\n        Option \"SendEventsMode\" \"enabled\"\n        Option \"Tapping\" \"on\"\n        Option \"TappingDragLock\" \"on\"\n        Option \"DisableWhileTyping\" \"off\"\n      EndSection\n\n      Section \"InputClass\"\n        Identifier \"libinput touchpad configuration\"\n        MatchDriver \"libinput\"\n        MatchIsTouchpad \"on\"\n        Option \"AccelProfile\" \"adaptive\"\n        Option \"LeftHanded\" \"off\"\n        Option \"MiddleEmulation\" \"on\"\n        Option \"NaturalScrolling\" \"off\"\n        Option \"ScrollMethod\" \"twofinger\"\n        Option \"HorizontalScrolling\" \"on\"\n        Option \"SendEventsMode\" \"enabled\"\n        Option \"Tapping\" \"on\"\n        Option \"TappingDragLock\" \"on\"\n        Option \"DisableWhileTyping\" \"off\"\n      EndSection\n\n      Section \"ServerLayout\"\n        Identifier \"Layout[all]\"\n        Inactive \"Device-amdgpu[0]\"\n\n        # Reference the Screen sections for each driver.  This will\n        # cause the X server to try each in turn.\n        Screen \"Screen-nvidia[0]\"\n        Screen \"Screen-amdgpu[0]\"\n      EndSection\n\n      # For each supported driver, add a \"Device\" and \"Screen\"\n      # section.\n      Section \"Device\"\n        Identifier \"Device-nvidia[0]\"\n        Driver \"nvidia\"\n        BusID \"PCI:1:0:0\"\n      EndSection\n\n      Section \"Screen\"\n        Identifier \"Screen-nvidia[0]\"\n        Device \"Device-nvidia[0]\"\n        Option \"RandRRotation\" \"on\"\n        Option \"AllowEmptyInitialConfiguration\"\n      EndSection\n\n      Section \"Screen\"\n        Identifier \"Screen-amdgpu[0]\"\n        Device \"Device-amdgpu[0]\"\n      EndSection\n\n\n      Section \"Device\"\n        Identifier \"Device-amdgpu[0]\"\n        Driver \"amdgpu\"\n        BusID \"PCI:5:0:0\"\n      EndSection\n    '';\n\n    services.xserver.displayManager.gdm.wayland = false;\n\n  };\n}\n"},{"End":{"CodeBlock":{"Fenced":"nix"}}},{"Html":"</details>\n"},{"Start":"Paragraph"},{"Text":"Exported "},{"Code":"xorg.conf"},{"End":"Paragraph"},{"Html":"<details title=\"xorg.conf\">\n"},{"Start":{"CodeBlock":{"Fenced":"xf86conf"}}},{"Text":"Section \"Files\"\n\n  FontPath \"/nix/store/qydzz8v6nl5n88aabc2glrayy3wd867q-unifont-14.0.04/share/fonts\"\n  FontPath \"/nix/store/23bir9f496d3q7z7r11l0139afm58ln3-font-cursor-misc-1.0.3/lib/X11/fonts/misc\"\n  FontPath \"/nix/store/zxg8rdv42bqs5rz4p7wwsdq9dlnp8qdp-font-misc-misc-1.1.2/lib/X11/fonts/misc\"\n  FontPath \"/nix/store/srf487s27nqn8vxxyv9jw9sl9fqif6b0-font-adobe-100dpi-1.0.3/lib/X11/fonts/100dpi\"\n  FontPath \"/nix/store/jsysicgm3ifrjzgvpwby4v9vsph3wkm8-font-adobe-75dpi-1.0.3/lib/X11/fonts/75dpi\"\n  ModulePath \"/nix/store/bji361pzh9knqbs182g0jgm22nw9wkgh-xf86-video-amdgpu-21.0.0/lib/xorg/modules/drivers\"\n  ModulePath \"/nix/store/bji361pzh9knqbs182g0jgm22nw9wkgh-xf86-video-amdgpu-21.0.0/lib/xorg/modules/drivers\"\n  ModulePath \"/nix/store/ib2y8r7s6xj408zgg9nsplcqsvpyykk9-nvidia-x11-515.48.07-5.18.6-bin/lib/xorg/modules/drivers\"\n  ModulePath \"/nix/store/ib2y8r7s6xj408zgg9nsplcqsvpyykk9-nvidia-x11-515.48.07-5.18.6-bin/lib/xorg/modules/extensions\"\n  ModulePath \"/nix/store/mjn47cwnwgy49zlcq7kv66smsy7r6ghv-xorg-server-1.20.14/lib/xorg/modules\"\n  ModulePath \"/nix/store/mjn47cwnwgy49zlcq7kv66smsy7r6ghv-xorg-server-1.20.14/lib/xorg/modules/drivers\"\n  ModulePath \"/nix/store/mjn47cwnwgy49zlcq7kv66smsy7r6ghv-xorg-server-1.20.14/lib/xorg/modules/extensions\"\n  ModulePath \"/nix/store/mrpw1zy65avf761yydyl5v2ya1247rs8-xf86-input-evdev-2.10.6/lib/xorg/modules/input\"\n  ModulePath \"/nix/store/cgrphl8qib783yp1g3xifsqv8bvksgsw-xf86-input-libinput-1.2.0/lib/xorg/modules/input\"\nFontPath \"/nix/store/f741iiyrs9dj9rf5nzx0r33gfic0jd1f-X11-fonts/share/X11/fonts\"\n\nEndSection\n\nSection \"ServerFlags\"\n  Option \"AllowMouseOpenFail\" \"on\"\n  Option \"DontZap\" \"on\"\nEndSection\n\nSection \"Module\"\nEndSection\n\nSection \"Monitor\"\n  Identifier \"Monitor[0]\"\nEndSection\n\n# Additional \"InputClass\" sections\nSection \"InputClass\"\n  Identifier \"libinput mouse configuration\"\n  MatchDriver \"libinput\"\n  MatchIsPointer \"on\"\n  Option \"AccelProfile\" \"adaptive\"\n  Option \"LeftHanded\" \"off\"\n  Option \"MiddleEmulation\" \"on\"\n  Option \"NaturalScrolling\" \"off\"\n  Option \"ScrollMethod\" \"twofinger\"\n  Option \"HorizontalScrolling\" \"on\"\n  Option \"SendEventsMode\" \"enabled\"\n  Option \"Tapping\" \"on\"\n  Option \"TappingDragLock\" \"on\"\n  Option \"DisableWhileTyping\" \"off\"\nEndSection\n\nSection \"InputClass\"\n  Identifier \"libinput touchpad configuration\"\n  MatchDriver \"libinput\"\n  MatchIsTouchpad \"on\"\n  Option \"AccelProfile\" \"adaptive\"\n  Option \"LeftHanded\" \"off\"\n  Option \"MiddleEmulation\" \"on\"\n  Option \"NaturalScrolling\" \"off\"\n  Option \"ScrollMethod\" \"twofinger\"\n  Option \"HorizontalScrolling\" \"on\"\n  Option \"SendEventsMode\" \"enabled\"\n  Option \"Tapping\" \"on\"\n  Option \"TappingDragLock\" \"on\"\n  Option \"DisableWhileTyping\" \"off\"\nEndSection\n\nSection \"ServerLayout\"\n  Identifier \"Layout[all]\"\n  Inactive \"Device-amdgpu[0]\"\n\n  # Reference the Screen sections for each driver.  This will\n  # cause the X server to try each in turn.\n  Screen \"Screen-nvidia[0]\"\n  Screen \"Screen-amdgpu[0]\"\nEndSection\n\n# For each supported driver, add a \"Device\" and \"Screen\"\n# section.\nSection \"Device\"\n  Identifier \"Device-nvidia[0]\"\n  Driver \"nvidia\"\n  BusID \"PCI:1:0:0\"\nEndSection\n\nSection \"Screen\"\n  Identifier \"Screen-nvidia[0]\"\n  Device \"Device-nvidia[0]\"\n  Option \"RandRRotation\" \"on\"\n  Option \"AllowEmptyInitialConfiguration\"\nEndSection\n\nSection \"Screen\"\n  Identifier \"Screen-amdgpu[0]\"\n  Device \"Device-amdgpu[0]\"\nEndSection\n\n\nSection \"Device\"\n  Identifier \"Device-amdgpu[0]\"\n  Driver \"amdgpu\"\n  BusID \"PCI:5:0:0\"\nEndSection\n"},{"End":{"CodeBlock":{"Fenced":"xf86conf"}}},{"Html":"</details>\n"},{"Start":"Paragraph"},{"Text":"I"},{"Text":"’"},{"Text":"m on nixpkgs unstable with the latest kernel. The thing I noticed trying to"},"SoftBreak",{"Text":"fix the crash were:"},{"End":"Paragraph"},{"Start":{"List":null}},{"Start":"Item"},{"Text":"You need both the "},{"Code":"amdgpu"},{"Text":" and "},{"Code":"nvidia"},{"Text":" video driver, or the explicit"},"SoftBreak",{"Text":"dependencies. ("},{"Code":"xf86videoamdgpu"},{"Text":","},{"Text":"…"},{"Text":")"},{"End":"Item"},{"Start":"Item"},{"Text":"The order in which you declare and the drivers and the "},{"Code":"Screen"},{"Text":"/"},{"Code":"Device"},"SoftBreak",{"Text":"sections are not the same. The "},{"Code":"amdgpu"},{"Text":" will always be the first, resulting"},"SoftBreak",{"Text":"in errors."},{"End":"Item"},{"Start":"Item"},{"Text":"The NVIDIA Screen must be the first with sync enabled. I would guess it"},"SoftBreak",{"Text":"should be the other way around for Reverse Prime."},{"End":"Item"},{"End":{"List":null}},{"Start":"Paragraph"},{"Text":"I"},{"Text":"’"},{"Text":"m not sure whether this is the cause of the crash, but I think the problem"},"SoftBreak",{"Text":"lies in how the dependencies and the final "},{"Code":"xorg.conf"},{"Text":" is generated."},{"End":"Paragraph"},{"Html":"<!-- Morning -->\n"},{"Html":"<!-- What do I want to do today? -->\n"},{"Html":"<!-- Evening -->\n"},{"Html":"<!-- What did I learn today? -->\n"},{"Html":"<!-- Things I learned -->\n"},{"Html":"<!-- Useful tools and libraries -->\n"}]}},"__N_SSG":true}